
# تحويل التطبيق إلى Offline-First PWA

## الوضع الحالي
التطبيق يعمل بنظام هجين:
- localStorage كـ cache سريع محلياً
- Supabase كقاعدة بيانات سحابية
- مزامنة عند بدء التشغيل وعند عودة الإنترنت

**المشكلة الحالية:** عند فقدان الإنترنت تماماً، التطبيق يعمل فقط إذا كانت localStorage ممتلئة، لكن التطبيق نفسه (الـ JS/CSS/HTML files) لا يُحمَّل إذا لم يكن هناك إنترنت.

## الهدف
```text
┌─────────────────────────────────────────┐
│           بن العميد PWA                  │
├─────────────────────────────────────────┤
│  Service Worker  │  يحفظ ملفات التطبيق  │
│  localStorage    │  يحفظ البيانات محلياً │
│  Sync Queue      │  يرسل عمليات معلقة   │
│  Supabase        │  قاعدة البيانات Cloud │
└─────────────────────────────────────────┘
```

## الخطوات التقنية

### 1. تثبيت vite-plugin-pwa
إضافة المكتبة وتعديل `vite.config.ts` لتفعيل Service Worker الذي يحفظ:
- ملفات HTML/JS/CSS (shell التطبيق)
- الأصوات والصور

### 2. إضافة manifest.json
ملف يُعرِّف التطبيق كـ PWA:
- اسم التطبيق: "بن العميد"
- أيقونة
- لون خلفية
- اتجاه: RTL

### 3. نظام Sync Queue للعمليات المعلقة
إنشاء `src/lib/offlineQueue.ts`:
- عند الكتابة وعدم وجود إنترنت → يُخزَّن العملية في localStorage Queue
- عند عودة الإنترنت → يرسل كل العمليات المعلقة تسلسلياً
- تجنب البيانات المكررة عبر timestamp IDs

### 4. تعديل `store.ts`
- دمج فحص الإنترنت قبل كل `dbUpsert*`
- إذا لا إنترنت → يُخزن في Queue بدل الإرسال الفوري
- عند عودة الإنترنت → flush Queue أولاً ثم sync

### 5. تحديث `App.tsx`
- إضافة حدث `beforeinstallprompt` لعرض زر "تثبيت التطبيق"
- إشعار للمستخدم عند وجود تحديث جديد للتطبيق

### 6. تحديث `AppLayout.tsx`
- مؤشر Sync Queue: "2 عملية في الانتظار"
- زر "مزامنة الآن" عند عودة الإنترنت
- رسالة واضحة: "وضع عدم الاتصال - البيانات محفوظة محلياً"

## ما يتغير للمستخدم

| الوضع | قبل | بعد |
|-------|-----|-----|
| بدون إنترنت | التطبيق لا يُحمَّل | يعمل بالكامل من الذاكرة |
| أثناء البيع | يحتاج إنترنت للـ sync | يسجل محلياً فوراً |
| عودة الإنترنت | يسحب من Cloud | يرفع العمليات المعلقة أولاً |
| تثبيت | من المتصفح فقط | زر "تثبيت" داخل التطبيق |

## الملفات المُعدَّلة

- `vite.config.ts` - إضافة vite-plugin-pwa
- `public/manifest.json` - تعريف PWA
- `public/sw.js` أو auto-generated - Service Worker
- `src/lib/offlineQueue.ts` - ملف جديد لإدارة Queue
- `src/lib/store.ts` - دمج فحص الاتصال والـ Queue
- `src/App.tsx` - install prompt + update notification
- `src/components/AppLayout.tsx` - مؤشر حالة Sync
- `index.html` - إضافة meta tags للـ PWA

## ملاحظة مهمة
البيانات الحالية في localStorage ستبقى كما هي، لذلك لن يفقد أي سجل موجود عند التحديث.
